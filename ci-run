#!/bin/bash


current_branch=`git rev-parse --abbrev-ref HEAD`

projects_to_test=`find * -maxdepth 0 -type d`
if [ "$current_branch" != "master" ]; then
    p=`git diff --name-only master..$current_branch | sed -n 's#\(.*\)/.*#\1#p'`
    projects_to_test=`echo ${p[@]//\/*} | xargs -n1 | sort -u | xargs`
fi

root_dir=`pwd`
return_code=0
for dir in $projects_to_test; do
    echo "Testing $dir"
    cd ${root_dir}/$dir
    docker run -v $(pwd):/snapcraft -t sergiusens/snapcraft sh -c "cd /snapcraft && snapcraft"
    ls *.snap
    if [ $? -ne 0 ]; then
        echo "FAILURE: No .snap file built"
        return_code=1
    fi
    echo "###############################################################################"
done

exit $return_code
